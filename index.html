<!DOCTYPE html>
<html>
<head>
  <title>Safe Routing System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 80vh;
      width: 100%;
    }
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
    }
    .controls input {
      margin: 0 5px;
      padding: 5px;
      width: 200px;
    }
    .controls button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="end" placeholder="End Location (lat,lng)" />
    <button onclick="displayRoute()">Get Route</button>
    <button onclick="checkRoute()">Check Route Suitability</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let userLatLng;

    navigator.geolocation.getCurrentPosition(position => {
      userLatLng = [position.coords.latitude, position.coords.longitude];
      map.setView(userLatLng, 13);
      L.marker(userLatLng).addTo(map)
        .bindPopup('You are here')
        .openPopup();
    }, error => {
      console.error('Error getting location', error);
      alert('Error getting location. Make sure location services are enabled.');
    });

    async function getRoute(start, end) {
      const apiKey = '5b3ce3597851110001cf624824b1456eb23945dc8552f3d7897b2554Y';
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${start[1]},${start[0]}&end=${end[1]},${end[0]}`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data.features[0].geometry;
      } catch (error) {
        console.error('Failed to fetch route:', error);
        throw error;
      }
    }

    async function displayRoute() {
      if (!userLatLng) {
        alert('Unable to get your current location');
        return;
      }

      const endInput = document.getElementById('end').value.split(',');
      if (endInput.length !== 2) {
        alert('Please enter a valid end location in the format lat,lng');
        return;
      }

      const end = [parseFloat(endInput[0]), parseFloat(endInput[1])];
      if (isNaN(end[0]) || isNaN(end[1])) {
        alert('Please enter a valid end location in the format lat,lng');
        return;
      }

      try {
        const route = await getRoute(userLatLng, end);

        if (window.routeLayer) {
          map.removeLayer(window.routeLayer);
        }

        window.routeLayer = L.geoJSON(route, {
          style: {
            color: 'blue',
            weight: 5
          }
        }).addTo(map);
      } catch (error) {
        alert('Error fetching the route: ' + error.message);
      }
    }

    async function checkRoute() {
      try {
        const response = await fetch('http://127.0.0.1:5000/check_route');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        alert(`Path suitability: ${data.suitability}\n` +
              `Number of vehicles with speed less than 30 km/h: ${data.slow_vehicles_count}\n` +
              `Number of vehicles with speed 30 km/h or higher: ${data.fast_vehicles_count}\n` +
              `Number of vehicles that have rerouted their paths: ${data.rerouted_vehicles_count}`);
      } catch (error) {
        alert('Error checking the route: ' + error.message);
      }
    }

    const hazards = [
      { lat: 51.507, lng: -0.08, description: 'Flood zone' },
      { lat: 51.508, lng: -0.09, description: 'Construction site' }
    ];

    hazards.forEach(hazard => {
      L.marker([hazard.lat, hazard.lng]).addTo(map)
        .bindPopup(hazard.description);
    });
  </script>
</body>
</html>
